import Head from "next/head";
import { fr } from "@codegouvfr/react-dsfr";
import { dataContractSchema } from "~/utils/forms/data-contract/schema";
import {
  BaseDataContractForm,
  dataContractFormDefaultValues,
} from "~/utils/forms/data-contract/form";
import { tss } from "tss-react";
import { api } from "~/utils/api";
import { Stepper } from "@codegouvfr/react-dsfr/Stepper";
import { useStepDataContractForm } from "~/utils/forms/data-contract/useStepForm";
import {
  DATA_CONTRACT_STEP_LABELS,
  DATA_CONTRACT_STEP_MAP,
  DATA_CONTRACT_STEPS,
} from "~/utils/forms/data-contract/stepMaps";
import { ButtonsGroup } from "@codegouvfr/react-dsfr/ButtonsGroup";
import { Toaster, toast } from "sonner";

export default function Home() {
  const { mutateAsync: createRequest } = api.request.create.useMutation();

  const { classes } = useStyles();

  const stepForm = useStepDataContractForm({
    defaultValues: dataContractFormDefaultValues,
    onFinalSubmit: async (values) => {
      await createRequest({ data: values });
      toast.success("Votre demande a bien été envoyée.");
      stepForm.setStep(0);
      stepForm.form.reset();
    },
  });

  const visible = DATA_CONTRACT_STEP_MAP[stepForm.step] as Array<
    keyof typeof dataContractSchema.shape
  >;

  return (
    <>
      <Head>
        <title>DCF - Accueil</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <Toaster position="top-center" richColors />
        <div className={fr.cx("fr-mt-4w", "fr-mb-8w")}>
          <h1>Formulaire de demande</h1>
          <Stepper
            currentStep={stepForm.step + 1}
            stepCount={DATA_CONTRACT_STEPS}
            title={DATA_CONTRACT_STEP_LABELS[stepForm.step]}
            nextTitle={
              DATA_CONTRACT_STEP_LABELS[stepForm.step + 1] ?? undefined
            }
            className={fr.cx("fr-mb-4w")}
          />
          <stepForm.form.AppForm>
            <form
              onSubmit={(e) => {
                e.preventDefault();
                e.stopPropagation();
                stepForm.isLast
                  ? stepForm.form.handleSubmit()
                  : stepForm.next();
              }}
            >
              <BaseDataContractForm
                form={stepForm.form}
                visibleSections={visible}
                formId="dcf"
              />
              <ButtonsGroup
                className={fr.cx("fr-mt-4w")}
                buttons={[
                  {
                    children: "Précédent",
                    iconId: "ri-arrow-left-line",
                    onClick: stepForm.previous,
                    priority: "tertiary",
                    iconPosition: "left",
                    type: "button",
                    disabled: stepForm.step === 0,
                  },
                  {
                    children: stepForm.isLast ? "Soumettre" : "Suivant",
                    iconId: stepForm.isLast
                      ? "ri-check-line"
                      : "ri-arrow-right-line",
                    type: "submit",
                    priority: "primary",
                    iconPosition: "right",
                    disabled: stepForm.isLast
                      ? stepForm.form.state.isSubmitting
                      : stepForm.form.state.isSubmitting ||
                        stepForm.form.state.isValidating,
                  },
                ]}
                alignment="right"
                buttonsEquisized
                inlineLayoutWhen="always"
              />
            </form>
          </stepForm.form.AppForm>
        </div>
      </main>
    </>
  );
}

const useStyles = tss.withName(Home.name).create(() => ({
  formWrapper: {
    display: "flex",
    flexDirection: "column",
    gap: fr.spacing("3w"),
  },
}));
